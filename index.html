<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online X-O Game (Tic-Tac-Toe)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons for UI elements -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/index.umd.js"></script>
    <style>
        /* Custom styles for the board and mobile layout */
        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            aspect-ratio: 1 / 1; /* Ensures board is always square */
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem; /* Larger for better touch target */
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            user-select: none;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .cell:hover:not(:empty) {
            transform: scale(1.05);
        }

        /* X and O colors */
        .cell-x { color: #34D399; } /* Emerald 400 */
        .cell-o { color: #60A5FA; } /* Blue 400 */

        /* Video Feed Styling */
        .video-feed {
            width: 100%;
            height: 100%;
            background: #1F2937;
            border-radius: 0.5rem;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror for selfie view */
        }
        
        .chat-control-icon {
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 font-sans flex items-center justify-center">

    <div id="app" class="w-full max-w-4xl space-y-6">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-indigo-400">Online X-O (Tic-Tac-Toe)</h1>
            <p id="user-info" class="text-sm text-gray-400 mt-2"></p>
        </header>

        <!-- Main Content Area: Divided for Game/Video and Controls -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- 1. Video and Game Board Container -->
            <div class="lg:w-2/3 flex flex-col gap-4">
                
                <!-- Video Feeds -->
                <div class="flex gap-4 h-48 sm:h-64">
                    <div class="flex-1 bg-gray-800 rounded-xl shadow-lg p-2 relative">
                        <video id="local-video" class="video-feed" autoplay playsinline muted></video>
                        <span class="absolute top-2 left-3 text-xs bg-indigo-500 px-2 py-0.5 rounded-full">You</span>
                    </div>
                    <div class="flex-1 bg-gray-800 rounded-xl shadow-lg p-2 relative">
                        <video id="remote-video" class="video-feed" autoplay playsinline></video>
                        <span class="absolute top-2 left-3 text-xs bg-green-500 px-2 py-0.5 rounded-full">Opponent</span>
                    </div>
                </div>

                <!-- Game Status and Board -->
                <div class="bg-gray-800 rounded-xl shadow-2xl p-6 flex flex-col items-center">
                    <p id="game-status" class="text-2xl font-bold mb-4 h-8 text-center text-indigo-300">
                        Loading...
                    </p>

                    <div id="game-board" class="border-4 border-gray-700 rounded-lg">
                        <!-- Cells generated by JavaScript -->
                    </div>
                </div>

            </div>

            <!-- 2. Controls and Room Management (lg:w-1/3) -->
<div id="controls" class="lg:w-1/3 bg-gray-800 rounded-xl shadow-lg p-6 space-y-6">
                
                <!-- Room Status -->
                <div class="text-center p-3 bg-gray-700 rounded-lg shadow-inner">
                    <p class="font-semibold text-gray-300">Room Code:</p>
                    <p id="room-display" class="text-3xl font-mono tracking-wider text-green-400 truncate mt-1">---</p>
                    <button id="copy-btn" class="text-sm text-indigo-400 hover:text-indigo-300 mt-2 hidden" onclick="copyRoomCode()">
                        <i class="ph-copy-bold chat-control-icon align-middle mr-1"></i> Copy Code
                    </button>
                </div>

                <!-- Connection Controls -->
                <div id="connection-controls" class="space-y-3">
                    <h2 class="text-xl font-semibold border-b border-gray-700 pb-2 text-indigo-300">Start a Game</h2>
                    
                    <button id="create-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-bold transition-all shadow-md" onclick="createRoom()">
                        <i class="ph-key-bold chat-control-icon align-middle mr-2"></i> Create Private Room
                    </button>
                    
                    <div class="flex gap-2">
                        <input type="text" id="room-input" placeholder="Enter Room Code" class="flex-1 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <button id="join-btn" class="py-3 px-4 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition-all shadow-md" onclick="joinRoom(document.getElementById('room-input').value)">
                            Join
                        </button>
                    </div>

                    <p class="text-center text-gray-400 pt-2">--- OR ---</p>
                    
                    <button id="random-btn" class="w-full py-3 bg-yellow-600 hover:bg-yellow-500 rounded-lg font-bold transition-all shadow-md" onclick="findRandomGame()" disabled>
                        <i class="ph-shuffle-bold chat-control-icon align-middle mr-2"></i> Find Random Match (Experimental)
                    </button>
                </div>

                <!-- Video/Audio Controls -->
                <div id="media-controls" class="space-y-3 pt-4 border-t border-gray-700">
                    <h2 class="text-xl font-semibold text-indigo-300">Call Controls</h2>
                    <div class="flex gap-3">
                        <button id="video-btn" class="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition-all" onclick="toggleVideo()">
                            <i class="ph-video-camera-slash-bold chat-control-icon align-middle mr-2"></i> Video OFF
                        </button>
                        <button id="audio-btn" class="flex-1 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition-all" onclick="toggleAudio()">
                            <i class="ph-microphone-slash-bold chat-control-icon align-middle mr-2"></i> Audio OFF
                        </button>
                    </div>
                    <button id="start-call-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold transition-all" onclick="startMediaAndCall()">
                        <i class="ph-phone-call-bold chat-control-icon align-middle mr-2"></i> Start Call
                    </button>
                </div>

                <!-- Reset Button -->
                <button id="reset-btn" class="w-full py-3 bg-gray-600 hover:bg-gray-500 rounded-lg font-bold transition-all mt-4" onclick="resetGame()">
                    New Game / Reset
                </button>
            </div>
        </div>
    </div>
<!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs, runTransaction, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ensure necessary global variables are available
        const appId = typeof app_id !== 'undefined' ? app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof firebase_config !== 'undefined' ? firebase_config : '{}');
        const initialAuthToken = typeof initial_auth_token !== 'undefined' ? initial_auth_token : null;

        // Global Firebase instances and state
        let app, db, auth;
        let userId = null;
        let gameRef = null;
        let unsubscribeGame = null;

        // Game State
        window.gameState = {
            board: ['', '', '', '', '', '', '', '', ''],
            players: { X: null, O: null },
            turn: 'X',
            status: 'lobby', // 'lobby', 'waiting', 'playing', 'finished'
            roomCode: null,
            isMyTurn: false,
            mySymbol: null, // 'X' or 'O'
            localStream: null,
            peerConnection: null,
            isCalling: false,
            videoEnabled: true,
            audioEnabled: true,
            remotePlayerId: null // Used for P2P signaling
        };
        
        // --- Utility Functions ---

        /** Generates a simple 6-character room code. */
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        /** Copies the room code to the clipboard. */
        window.copyRoomCode = function() {
            const roomCode = window.gameState.roomCode;
            if (roomCode) {
                navigator.clipboard.writeText(roomCode).then(() => {
                    alert('Room code copied to clipboard!'); // Using a simple alert for quick feedback
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                });
            }
        };

        /** Updates the main UI elements based on the current game state. */
        function updateUI() {
            const { board, turn, status, roomCode, mySymbol, isMyTurn } = window.gameState;
            const gameStatusEl = document.getElementById('game-status');
            const roomDisplayEl = document.getElementById('room-display');
            const copyBtn = document.getElementById('copy-btn');
            const boardEl = document.getElementById('game-board');

            roomDisplayEl.textContent = roomCode || '---';
            copyBtn.classList.toggle('hidden', !roomCode);

            // 1. Board Rendering
            boardEl.innerHTML = board.map((cell, index) => 
                <div class="cell bg-gray-700 hover:bg-gray-600 active:bg-gray-500 border-gray-600 ${cell === 'X' ? 'cell-x' : cell === 'O' ? 'cell-o' : ''} ${isMyTurn && cell === '' ? 'cursor-pointer' : 'cursor-default'}" 
                      data-index="${index}" 
                      onclick="makeMove(${index})">
                    ${cell}
                </div>
            ).join('');

            // 2. Status Message
            let statusText = 'Lobby: Create or Join a Room';
            let color = 'text-indigo-300';
            
            if (status === 'waiting' && mySymbol === 'X') {
                statusText = 'Waiting for Opponent to Join...';
color = 'text-yellow-400';
            } else if (status === 'waiting' && mySymbol === 'O') {
                statusText = 'Joining...';
                color = 'text-yellow-400';
            } else if (status === 'playing') {
                if (isMyTurn) {
                    statusText = Your Turn (${mySymbol})!;
                    color = (mySymbol === 'X' ? 'text-green-400' : 'text-blue-400');
                } else {
                    statusText = Opponent's Turn (${turn}).;
                    color = 'text-red-400';
                }
            } else if (status === 'finished') {
                const winner = board.winner;
                if (winner === 'Draw') {
                    statusText = 'Game Over: It\'s a Draw!';
                    color = 'text-gray-300';
                } else {
                    statusText = Game Over: ${winner} Wins!;
                    color = 'text-green-500';
                }
            }

            gameStatusEl.textContent = statusText;
            gameStatusEl.className = text-2xl font-bold mb-4 h-8 text-center ${color};
        }

        /** Checks for a winner or a draw. */
        function checkWin(board) {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
                [0, 4, 8], [2, 4, 6]             // Diagonals
            ];

            for (let i = 0; i < lines.length; i++) {
                const [a, b, c] = lines[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a]; // Returns 'X' or 'O'
                }
            }

            if (board.every(cell => cell !== '')) {
                return 'Draw'; // Returns 'Draw'
            }

            return null;
        }

        // --- Game Logic ---

        /** Handles local move and updates Firestore. */
        window.makeMove = async function(index) {
            const { mySymbol, board, turn, status, roomCode, isMyTurn } = window.gameState;

            if (status !== 'playing'  !isMyTurn  board[index] !== '') {
                console.log("Invalid move or not your turn.");
                return;
            }

            const newBoard = [...board];
            newBoard[index] = mySymbol;
            const winner = checkWin(newBoard);
            const newTurn = mySymbol === 'X' ? 'O' : 'X';
            const newStatus = winner ? 'finished' : 'playing';
            
            // Determine the remote player ID for call signaling
            const remoteId = mySymbol === 'X' ? window.gameState.players.O : window.gameState.players.X;

            const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'xogames', roomCode);

            try {
                await setDoc(roomDocRef, {
                    board: newBoard,
                    turn: newTurn,
                    status: newStatus,
                    winner: winner || null,
                    // If we made a move, clear any pending WebRTC signaling data
                    [webrtc_${remoteId}]: arrayRemove({ type: 'offer' }, { type: 'answer' }, { type: 'candidate' })
                }, { merge: true });
            } catch (error) {
                console.error("Error updating game state:", error);
                alert("Failed to make move. Please check console for details.");
            }
        };

        /** Sets up the game board UI and initializes listeners. */
        function initializeBoard() {
            const boardEl = document.getElementById('game-board');
            boardEl.addEventListener('click', (event) => {
                const index = event.target.dataset.index;
                if (index !== undefined) {
                    window.makeMove(parseInt(index));
                }
            });
            updateUI();
        }
/** Subscribes to the game document for real-time updates. */
        function subscribeToGame(roomCode) {
            if (unsubscribeGame) {
                unsubscribeGame();
            }

            const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'xogames', roomCode);

            unsubscribeGame = onSnapshot(roomDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    console.error("Game room disappeared.");
                    window.gameState.status = 'lobby';
                    window.gameState.roomCode = null;
                    updateUI();
                    return;
                }
                
                const data = docSnap.data();
                
                // Update local state from Firestore
                window.gameState.board = data.board || window.gameState.board;
                window.gameState.turn = data.turn || 'X';
                window.gameState.status = data.status || 'playing';
                window.gameState.players = data.players || { X: null, O: null };
                
                // Determine player role and turn
                const { players, turn, status } = window.gameState;
                window.gameState.mySymbol = players.X === userId ? 'X' : players.O === userId ? 'O' : null;
                window.gameState.isMyTurn = (window.gameState.mySymbol && turn === window.gameState.mySymbol && status === 'playing');
                window.gameState.remotePlayerId = window.gameState.mySymbol === 'X' ? players.O : players.X;
                
                console.log("Game state updated. My symbol:", window.gameState.mySymbol, "Turn:", turn, "Is my turn:", window.gameState.isMyTurn);
                
                updateUI();
                
                // Handle WebRTC Signaling (Offers/Answers/Candidates)
                handleSignaling(data);

            }, (error) => {
                console.error("Error listening to game state:", error);
            });
            
            console.log("Subscribed to room:", roomCode);
            window.gameState.roomCode = roomCode;
        }

        /** Creates a new game room. */
        window.createRoom = async function() {
            const newCode = generateRoomCode();
            const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'xogames', newCode);

            if (!userId) { console.error("User not authenticated."); return; }

            try {
                await setDoc(roomDocRef, {
                    board: ['', '', '', '', '', '', '', '', ''],
                    players: { X: userId, O: null },
                    turn: 'X',
                    status: 'waiting',
                    winner: null,
                    createdAt: new Date().getTime(),
                });
                
                console.log("Room created:", newCode);
                window.gameState.mySymbol = 'X';
                window.gameState.status = 'waiting';
                subscribeToGame(newCode);

            } catch (error) {
                console.error("Error creating room:", error);
                alert("Failed to create room.");
            }
        };

        /** Joins an existing game room. */
        window.joinRoom = async function(roomCode) {
            if (!roomCode || roomCode.length < 6) { alert("Please enter a valid room code."); return; }
            const roomDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'xogames', roomCode);

            if (!userId) { console.error("User not authenticated."); return; }

            try {
                // Use a transaction to safely update the player list
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(roomDocRef);

                    if (!docSnap.exists()) {
                        throw new Error("Room does not exist.");
                    }
const data = docSnap.data();
                    if (data.players.O) {
                        throw new Error("Room is already full.");
                    }

                    // Player O joins
                    transaction.update(roomDocRef, {
                        'players.O': userId,
                        status: 'playing'
                    });
                });

                console.log("Room joined:", roomCode);
                window.gameState.mySymbol = 'O';
                window.gameState.status = 'playing';
                subscribeToGame(roomCode);